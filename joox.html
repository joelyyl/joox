<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Joox - Social Platform with Games</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', sans-serif;
        }
        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            justify-content: center;
            align-items: center;
            transition: background 0.5s ease, color 0.5s ease;
        }
        body.light {
            background: linear-gradient(135deg, #e0f7fa, #b2ebf2);
            color: #333;
        }
        body.dark {
            background: linear-gradient(135deg, #263238, #455a64);
            color: #e0e0e0;
        }
        header {
            padding: 20px;
            text-align: center;
            background: linear-gradient(90deg, #1446FF, #1976D2);
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 1200px;
            margin: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        header h1 {
            font-size: 36px;
            margin-bottom: 5px;
        }
        header p {
            font-size: 18px;
        }
        #profile-pic {
            width: 50px;
            height: 70px;
            border-radius: 50%;
        }
        #jooxbucks {
            font-size: 16px;
            margin-top: 5px;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            width: 100%;
            max-width: 450px;
            margin: 20px;
            display: none;
            transition: transform 0.3s ease;
        }
        body.dark .container {
            background: #37474f;
            color: #e0e0e0;
        }
        .container.active {
            display: block;
            transform: scale(1.02);
        }
        h2 {
            text-align: center;
            margin-bottom: 20px;
            font-weight: 600;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
        }
        input[type="text"],
        input[type="date"],
        input[type="number"],
        input[type="password"],
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        body.dark input,
        body.dark select,
        body.dark textarea {
            background: #546e7a;
            border-color: #78909c;
            color: #e0e0e0;
        }
        input[type="text"]:focus,
        input[type="date"]:focus,
        input[type="number"]:focus,
        input[type="password"]:focus,
        select:focus,
        textarea:focus {
            border-color: #1446FF;
            outline: none;
        }
        button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(90deg, #1446FF, #1976D2);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.2s ease;
        }
        button:hover {
            background: linear-gradient(90deg, #0033cc, #1446FF);
            transform: scale(1.05);
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .links {
            text-align: center;
            margin-top: 15px;
        }
        .links a {
            color: #1446FF;
            text-decoration: none;
            font-weight: 500;
            margin: 0 10px;
        }
        body.dark .links a {
            color: #64b5f6;
        }
        .links a:hover {
            text-decoration: underline;
            color: #0033cc;
        }
        body.dark .links a:hover {
            color: #42a5f5;
        }
        .back-button {
            display: inline-block;
            margin-bottom: 20px;
            color: #1446FF;
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
        }
        body.dark .back-button {
            color: #64b5f6;
        }
        .back-button:hover {
            text-decoration: underline;
        }
        #homepage-container {
            display: none;
            width: 100%;
            max-width: 1200px;
            padding: 20px;
        }
        #homepage-container header {
            border-radius: 10px 10px 0 0;
        }
        nav ul {
            list-style: none;
            display: flex;
            gap: 20px;
        }
        nav ul li a {
            color: white;
            text-decoration: none;
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 5px;
            transition: background 0.3s ease;
        }
        nav ul li a:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .search-bar {
            padding: 8px;
            border-radius: 5px;
            border: none;
            width: 200px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .content {
            background: white;
            padding: 25px;
            border-radius: 0 0 15px 15px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        body.dark .content {
            background: #37474f;
        }
        .friends-section, .games-section, .marketplace-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-top: 25px;
        }
        .friend-card, .game-card, .marketplace-card {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }
        body.dark .friend-card, body.dark .game-card, body.dark .marketplace-card {
            background: #455a64;
        }
        .friend-card:hover, .game-card:hover, .marketplace-card:hover {
            transform: translateY(-5px);
        }
        .friend-card h3, .game-card h3, .marketplace-card h3 {
            margin-bottom: 15px;
            font-weight: 600;
        }
        .friend-card button, .game-card button, .marketplace-card button {
            width: auto;
            padding: 8px 16px;
        }
        .friend-requests ul, .friends-list ul {
            list-style: none;
            padding: 0;
        }
        .friend-requests li, .friends-list li {
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px;
            background: #fff;
            border-radius: 5px;
        }
        body.dark .friend-requests li, body.dark .friends-list li {
            background: #546e7a;
        }
        #games-container, #game-obstacle-container, #game-reaction-container, #game-trivia-container {
            display: none;
            width: 100%;
            max-width: 900px;
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        body.dark #games-container, body.dark #game-obstacle-container, body.dark #game-reaction-container, body.dark #game-trivia-container {
            background: #37474f;
        }
        canvas {
            border: 2px solid #ddd;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        body.dark canvas {
            border-color: #78909c;
        }
        #admin-container {
            display: none;
            width: 100%;
            max-width: 450px;
        }
        .admin-option {
            margin-bottom: 20px;
        }
        #settings-container {
            display: none;
            width: 100%;
            max-width: 450px;
        }
        #notifications-container {
            display: none;
            width: 100%;
            max-width: 900px;
        }
        #notifications-list {
            max-height: 400px;
            overflow-y: auto;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            background: #f9f9f9;
        }
        body.dark #notifications-list {
            background: #455a64;
            border-color: #78909c;
        }
        #notifications-list p {
            margin: 8px 0;
            padding: 8px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        body.dark #notifications-list p {
            background: #546e7a;
        }
        #profile-container {
            display: none;
            width: 100%;
            max-width: 450px;
            text-align: center;
        }
        #profile-avatar {
            width: 100px;
            height: 140px;
            border-radius: 50%;
            margin: 20px auto;
        }
        #marketplace-container {
            display: none;
            width: 100%;
            max-width: 900px;
        }
        #accessories-list {
            margin-top: 20px;
        }
        #accessories-list div {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
            text-align: center;
            z-index: 1000;
            display: none;
        }
        #ban-menu {
            background: #1e1e1e;
            color: #fff;
            padding: 40px;
            border-radius: 15px;
            width: 400px;
            max-width: 90vw;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5);
        }
        #ban-menu h2 {
            color: #ff4444;
            margin-bottom: 20px;
            font-size: 28px;
        }
        #ban-menu p {
            font-size: 16px;
            margin-bottom: 10px;
        }
        #ban-reason-text, #ban-duration-text {
            background: #333;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        #ban-menu button {
            background: #ff4444;
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 5px;
        }
        #ban-menu button:hover {
            background: #cc3333;
        }
        @media (max-width: 480px) {
            .container, #homepage-container, #games-container, #game-obstacle-container, #game-reaction-container, #game-trivia-container, #admin-container, #settings-container, #notifications-container, #profile-container, #marketplace-container {
                max-width: 90vw;
            }
            header {
                flex-direction: column;
                gap: 10px;
            }
            #homepage-container header {
                flex-direction: column;
                align-items: flex-start;
            }
            #homepage-container header h1 {
                margin-bottom: 10px;
            }
            nav ul {
                flex-direction: column;
                gap: 10px;
            }
            .search-bar {
                width: 100%;
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="light">
    <header>
        <div>
            <h1>Joox</h1>
            <p id="welcome-message"></p>
            <p id="jooxbucks"></p>
        </div>
        <canvas id="profile-pic" width="50" height="70"></canvas>
    </header>

    <!-- Login Form -->
    <div id="login-container" class="container active">
        <h2>Log In to Joox</h2>
        <form id="login-form">
            <div class="form-group">
                <label for="login-username">Username</label>
                <input type="text" id="login-username" placeholder="Enter your username" required>
            </div>
            <div class="form-group">
                <label for="login-password">Password</label>
                <input type="password" id="login-password" placeholder="Enter your password" required>
            </div>
            <button type="submit">Log In</button>
            <div class="links">
                <a onclick="switchToSignUp()">Sign Up</a>
                <a href="#">Forgot Password?</a>
            </div>
        </form>
    </div>

    <!-- Sign-Up Form -->
    <div id="signup-container" class="container">
        <h2>Sign Up for Joox</h2>
        <form id="signup-form">
            <div class="form-group">
                <label for="signup-username">Username</label>
                <input type="text" id="signup-username" placeholder="Choose a username" maxlength="20" required>
            </div>
            <div class="form-group">
                <label for="signup-birthdate">Birth Date</label>
                <input type="date" id="signup-birthdate" required>
            </div>
            <div class="form-group">
                <label for="signup-password">Password</label>
                <input type="password" id="signup-password" placeholder="Create a password" required>
            </div>
            <div class="form-group">
                <label for="signup-confirm-password">Confirm Password</label>
                <input type="password" id="signup-confirm-password" placeholder="Confirm your password" required>
            </div>
            <button type="submit">Sign Up</button>
            <div class="links">
                <a onclick="switchToLogin()">Log In</a>
            </div>
        </form>
    </div>

    <!-- Homepage -->
    <div id="homepage-container">
        <header>
            <h1>Welcome to Joox</h1>
            <input type="text" class="search-bar" placeholder="Search games...">
            <nav>
                <ul>
                    <li><a href="#" onclick="showGames()">Discover</a></li>
                    <li><a href="#" onclick="showAvatar()">Avatar</a></li>
                    <li><a href="#" onclick="displayFriends()">Friends</a></li>
                    <li><a href="#" onclick="showNotifications()">Notifications</a></li>
                    <li><a href="#" onclick="showSettings()">Settings</a></li>
                    <li><a href="#" onclick="showProfile()">Profile</a></li>
                    <li><a href="#" onclick="showAdmin()">Admin</a></li>
                    <li><a href="#" onclick="logout()">Logout</a></li>
                </ul>
            </nav>
        </header>
        <div class="content">
            <h2>Friends</h2>
            <div class="friends-section">
                <div class="friend-card">
                    <h3>Search Friends</h3>
                    <input type="text" id="friend-search" placeholder="Enter username">
                    <button onclick="searchUsers()">Search</button>
                    <div id="search-results"></div>
                </div>
                <div class="friend-card">
                    <h3>Friends List</h3>
                    <div id="friends-list"><ul></ul></div>
                </div>
                <div class="friend-card">
                    <h3>Friend Requests</h3>
                    <div id="friend-requests"><ul></ul></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Games Container -->
    <div id="games-container" class="container">
        <h2>Games</h2>
        <div class="games-section">
            <div class="game-card">
                <h3>Obstacle Parkour</h3>
                <button onclick="startObstacleGame()" id="obstacle-btn">Play</button>
            </div>
            <div class="game-card">
                <h3>Reaction Speed Game</h3>
                <button onclick="startReactionGame()" id="reaction-btn">Play</button>
            </div>
            <div class="game-card">
                <h3>Trivia Game</h3>
                <button onclick="startTriviaGame()" id="trivia-btn">Play</button>
            </div>
        </div>
    </div>

    <!-- Obstacle Parkour Game -->
    <div id="game-obstacle-container" class="container">
        <canvas id="obstacle-canvas" width="800" height="400"></canvas>
        <p>Use WASD to move, Space to jump</p>
        <button onclick="leaveGame('obstacle')">Leave Game</button>
    </div>

    <!-- Reaction Speed Game -->
    <div id="game-reaction-container" class="container">
        <canvas id="reaction-canvas" width="800" height="400"></canvas>
        <p>Click the green square as fast as you can!</p>
        <button onclick="leaveGame('reaction')">Leave Game</button>
    </div>

    <!-- Trivia Game -->
    <div id="game-trivia-container" class="container">
        <canvas id="trivia-canvas" width="800" height="400"></canvas>
        <p id="trivia-question"></p>
        <div id="trivia-answers"></div>
        <button onclick="leaveGame('trivia')">Leave Game</button>
    </div>

    <!-- Admin Container -->
    <div id="admin-container" class="container">
        <a class="back-button" onclick="showHomepage()">< Go Back</a>
        <h2>Admin Panel</h2>
        <div class="form-group">
            <label for="admin-username">Username</label>
            <input type="text" id="admin-username" placeholder="Enter username (leave blank to notify all)">
        </div>
        <div class="admin-option">
            <h3>Ban User</h3>
            <div class="form-group">
                <label for="ban-reason">Reason</label>
                <textarea id="ban-reason" placeholder="Reason for ban"></textarea>
            </div>
            <div class="form-group">
                <label for="ban-duration">Duration</label>
                <select id="ban-duration">
                    <option value="1">1 Day</option>
                    <option value="7">7 Days</option>
                    <option value="14">14 Days</option>
                    <option value="permanent">Permanent</option>
                </select>
            </div>
            <button onclick="banUser()">Ban</button>
        </div>
        <div class="admin-option">
            <h3>Unban User</h3>
            <div class="form-group">
                <label for="unban-reason">Reason</label>
                <textarea id="unban-reason" placeholder="Reason for unban"></textarea>
            </div>
            <button onclick="unbanUser()">Unban</button>
        </div>
        <div class="admin-option">
            <h3>Send Notification</h3>
            <div class="form-group">
                <label for="notification-text">Notification</label>
                <textarea id="notification-text" placeholder="Notification content"></textarea>
            </div>
            <button onclick="sendAdminNotification()">Send</button>
        </div>
    </div>

    <!-- Avatar Customization Container -->
    <div id="avatar-container" class="container">
        <h2>Customize Your Avatar</h2>
        <canvas id="avatar-preview" width="100" height="140" style="margin-bottom: 20px;"></canvas>
        <div class="avatar-section">
            <div class="avatar-card">
                <h3>Head Color</h3>
                <select id="head-color" onchange="updateAvatarPreview()">
                    <option value="#ff9999">Red</option>
                    <option value="#99ccff">Blue</option>
                    <option value="#99ff99">Green</option>
                    <option value="#ff69b4">Pink</option>
                    <option value="#800080">Purple</option>
                    <option value="#ffa500">Orange</option>
                </select>
            </div>
            <div class="avatar-card">
                <h3>Torso Color</h3>
                <select id="torso-color" onchange="updateAvatarPreview()">
                    <option value="#ff9999">Red</option>
                    <option value="#99ccff">Blue</option>
                    <option value="#99ff99">Green</option>
                    <option value="#ff69b4">Pink</option>
                    <option value="#800080">Purple</option>
                    <option value="#ffa500">Orange</option>
                </select>
            </div>
            <div class="avatar-card">
                <h3>Legs Color</h3>
                <select id="legs-color" onchange="updateAvatarPreview()">
                    <option value="#ff9999">Red</option>
                    <option value="#99ccff">Blue</option>
                    <option value="#99ff99">Green</option>
                    <option value="#ff69b4">Pink</option>
                    <option value="#800080">Purple</option>
                    <option value="#ffa500">Orange</option>
                </select>
            </div>
        </div>
        <button onclick="saveAvatar()">Save Avatar</button>
        <button onclick="showMarketplace()">Marketplace</button>
        <button onclick="showAccessories()">Customize Accessories</button>
        <div id="accessories-list" style="display: none;"></div>
    </div>

    <!-- Settings Container -->
    <div id="settings-container" class="container">
        <a class="back-button" onclick="showHomepage()">< Go Back</a>
        <h2>Settings</h2>
        <div class="form-group">
            <label>Theme</label>
            <select id="theme-select" onchange="toggleTheme()">
                <option value="light">Light Mode</option>
                <option value="dark">Dark Mode</option>
            </select>
        </div>
        <div class="form-group">
            <label for="new-username">Change Username</label>
            <input type="text" id="new-username" placeholder="New username" maxlength="20">
            <button onclick="changeUsername()">Change</button>
        </div>
    </div>

    <!-- Notifications Container -->
    <div id="notifications-container" class="container">
        <a class="back-button" onclick="showHomepage()">< Go Back</a>
        <h2>Notifications</h2>
        <div id="notifications-list"></div>
    </div>

    <!-- Profile Container -->
    <div id="profile-container" class="container">
        <canvas id="profile-avatar" width="100" height="140"></canvas>
        <h2 id="profile-username"></h2>
    </div>

    <!-- Marketplace Container -->
    <div id="marketplace-container" class="container">
        <h2>Marketplace</h2>
        <div class="marketplace-section">
            <div class="marketplace-card">
                <h3>Metro Character</h3>
                <p>Cost: 120 J$</p>
                <button onclick="purchaseItem('metro')">Purchase</button>
            </div>
            <div class="marketplace-card">
                <h3>Circle Head</h3>
                <p>Cost: 60 J$</p>
                <button onclick="purchaseItem('circle')">Purchase</button>
            </div>
            <div class="marketplace-card">
                <h3>Customized Shirt</h3>
                <p>Cost: 25 J$</p>
                <input type="text" id="shirt-text" placeholder="Enter shirt text" maxlength="20">
                <button onclick="purchaseItem('shirt')">Purchase</button>
            </div>
            <div class="marketplace-card">
                <h3>Hat</h3>
                <p>Cost: 50 J$</p>
                <button onclick="purchaseItem('hat')">Purchase</button>
            </div>
            <div class="marketplace-card">
                <h3>Pants</h3>
                <p>Cost: 75 J$</p>
                <button onclick="purchaseItem('pants')">Purchase</button>
            </div>
            <div class="marketplace-card">
                <h3>Shoes</h3>
                <p>Cost: 40 J$</p>
                <button onclick="purchaseItem('shoes')">Purchase</button>
            </div>
            <div class="marketplace-card">
                <h3>Glasses</h3>
                <p>Cost: 30 J$</p>
                <button onclick="purchaseItem('glasses')">Purchase</button>
            </div>
            <div class="marketplace-card">
                <h3>Backpack</h3>
                <p>Cost: 100 J$</p>
                <button onclick="purchaseItem('backpack')">Purchase</button>
            </div>
        </div>
    </div>

    <!-- Popups -->
    <div id="ban-menu" class="popup">
        <h2>Account Banned</h2>
        <p>Your account has been banned from Joox.</p>
        <p><strong>Reason:</strong></p>
        <p id="ban-reason-text"></p>
        <p><strong>Duration:</strong></p>
        <p id="ban-duration-text"></p>
        <button onclick="acknowledgeBan()">Acknowledge</button>
    </div>

    <!-- Scripts -->
    <script>
        const loginContainer = document.getElementById('login-container');
        const signupContainer = document.getElementById('signup-container');
        const homepageContainer = document.getElementById('homepage-container');
        const gamesContainer = document.getElementById('games-container');
        const gameObstacleContainer = document.getElementById('game-obstacle-container');
        const gameReactionContainer = document.getElementById('game-reaction-container');
        const gameTriviaContainer = document.getElementById('game-trivia-container');
        const adminContainer = document.getElementById('admin-container');
        const avatarContainer = document.getElementById('avatar-container');
        const settingsContainer = document.getElementById('settings-container');
        const notificationsContainer = document.getElementById('notifications-container');
        const profileContainer = document.getElementById('profile-container');
        const marketplaceContainer = document.getElementById('marketplace-container');
        const banMenu = document.getElementById('ban-menu');
        const loginForm = document.getElementById('login-form');
        const signupForm = document.getElementById('signup-form');
        const profilePicCanvas = document.getElementById('profile-pic');
        const avatarPreviewCanvas = document.getElementById('avatar-preview');
        const profileAvatarCanvas = document.getElementById('profile-avatar');
        const friendSearch = document.getElementById('friend-search');
        const searchResults = document.getElementById('search-results');
        const friendsList = document.getElementById('friends-list').querySelector('ul');
        const friendRequests = document.getElementById('friend-requests').querySelector('ul');
        const accessoriesList = document.getElementById('accessories-list');
        let currentUser = null;
        let gameInterval = null;

        const swearWords = ['fuck', 'shit', 'ass', 'bitch', 'damn', 'cunt', 'cock', 'pussy', 'nigger', 'fag'];
        const GLOBAL_USERS_KEY = 'joox_global_users';

        function getGlobalUsers() {
            return JSON.parse(localStorage.getItem(GLOBAL_USERS_KEY) || '{}');
        }

        function setGlobalUsers(users) {
            localStorage.setItem(GLOBAL_USERS_KEY, JSON.stringify(users));
        }

        function switchToSignUp() {
            loginContainer.classList.remove('active');
            signupContainer.classList.add('active');
        }

        function switchToLogin() {
            signupContainer.classList.remove('active');
            loginContainer.classList.add('active');
        }

        function showHomepage() {
            hideAllContainers();
            homepageContainer.style.display = 'block';
            document.getElementById('welcome-message').textContent = `Welcome, @${currentUser}`;
            updateJooxBucks();
            displayFriends();
            loadTheme();
            updateProfilePic();
            if (gameInterval) {
                clearInterval(gameInterval);
                gameInterval = null;
            }
        }

        function hideAllContainers() {
            loginContainer.classList.remove('active');
            signupContainer.classList.remove('active');
            homepageContainer.style.display = 'none';
            gamesContainer.style.display = 'none';
            gameObstacleContainer.style.display = 'none';
            gameReactionContainer.style.display = 'none';
            gameTriviaContainer.style.display = 'none';
            adminContainer.style.display = 'none';
            avatarContainer.style.display = 'none';
            settingsContainer.style.display = 'none';
            notificationsContainer.style.display = 'none';
            profileContainer.style.display = 'none';
            marketplaceContainer.style.display = 'none';
            banMenu.style.display = 'none';
            accessoriesList.style.display = 'none';
        }

        function showGames() {
            hideAllContainers();
            gamesContainer.style.display = 'block';
        }

        function startObstacleGame() {
            hideAllContainers();
            gameObstacleContainer.style.display = 'block';
            startObstacle();
            startJooxBucksTimer();
        }

        function startReactionGame() {
            hideAllContainers();
            gameReactionContainer.style.display = 'block';
            startReaction();
            startJooxBucksTimer();
        }

        function startTriviaGame() {
            hideAllContainers();
            gameTriviaContainer.style.display = 'block';
            startTrivia();
            startJooxBucksTimer();
        }

        function leaveGame(gameType) {
            if (gameType === 'obstacle') stopObstacle();
            if (gameType === 'reaction') stopReaction();
            if (gameType === 'trivia') stopTrivia();
            showHomepage();
        }

        function showAdmin() {
            if (currentUser === 'OfficialJoox') {
                hideAllContainers();
                adminContainer.style.display = 'block';
            } else {
                alert('Access denied. Admin only.');
            }
        }

        function showAvatar() {
            hideAllContainers();
            avatarContainer.style.display = 'block';
            loadAvatar();
            updateAvatarPreview();
        }

        function showSettings() {
            hideAllContainers();
            settingsContainer.style.display = 'block';
            loadTheme();
        }

        function showNotifications() {
            hideAllContainers();
            notificationsContainer.style.display = 'block';
            displayNotifications();
        }

        function showProfile() {
            hideAllContainers();
            profileContainer.style.display = 'block';
            updateProfileDisplay();
        }

        function showMarketplace() {
            hideAllContainers();
            marketplaceContainer.style.display = 'block';
        }

        function showAccessories() {
            const users = getGlobalUsers();
            const userData = users[currentUser];
            const accessories = userData.avatar.accessories;

            accessoriesList.innerHTML = '<h3>Purchased Accessories</h3>';
            if (accessories.length === 0) {
                accessoriesList.innerHTML += '<p>No accessories purchased.</p>';
            } else {
                accessories.forEach(item => {
                    const div = document.createElement('div');
                    div.innerHTML = `${item} <button onclick="removeAccessory('${item}')">Remove</button>`;
                    accessoriesList.appendChild(div);
                });
            }
            accessoriesList.style.display = 'block';
        }

        function removeAccessory(item) {
            const users = getGlobalUsers();
            const userData = users[currentUser];
            userData.avatar.accessories = userData.avatar.accessories.filter(acc => acc !== item);
            if (item === 'shirt') delete userData.avatar.shirtText; // Clear shirt text if removing shirt
            setGlobalUsers(users);
            updateAvatarPreview();
            updateProfilePic();
            updateProfileDisplay();
            showAccessories(); // Refresh the list
        }

        function logout() {
            sessionStorage.removeItem('loggedInUser');
            currentUser = null;
            hideAllContainers();
            loginContainer.classList.add('active');
            document.getElementById('welcome-message').textContent = '';
            document.getElementById('jooxbucks').textContent = '';
            if (gameInterval) clearInterval(gameInterval);
        }

        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value;
            const users = getGlobalUsers();

            if (users[username] && users[username].password === password) {
                if (users[username].banned) {
                    const banUntil = users[username].banUntil;
                    const banReason = users[username].banReason;
                    if (banUntil !== 'permanent' && Date.now() > banUntil) {
                        users[username].banned = false;
                        users[username].banReason = '';
                        users[username].banUntil = null;
                        users[username].notifications.push('Your ban has expired.');
                        setGlobalUsers(users);
                        sessionStorage.setItem('loggedInUser', username);
                        currentUser = username;
                        showHomepage();
                        alert('Logged in successfully!');
                    } else {
                        showBanMenu(banReason, banUntil);
                    }
                } else {
                    sessionStorage.setItem('loggedInUser', username);
                    currentUser = username;
                    showHomepage();
                    alert('Logged in successfully!');
                }
            } else {
                alert('Invalid username or password');
            }
        });

        signupForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('signup-username').value.trim();
            const birthdate = document.getElementById('signup-birthdate').value;
            const password = document.getElementById('signup-password').value;
            const confirmPassword = document.getElementById('signup-confirm-password').value;

            if (password !== confirmPassword) {
                alert('Passwords do not match');
                return;
            }

            if (!isValidUsername(username)) {
                alert('Username must be 1-20 characters, use only Latin letters, numbers, or "_", and no inappropriate words.');
                return;
            }

            let users = getGlobalUsers();
            if (users[username]) {
                alert('Username already exists');
                return;
            }

            const age = calculateAge(birthdate);
            const canChat = age > 12;

            users[username] = {
                password,
                birthdate,
                friends: [],
                friendRequestsSent: [],
                friendRequestsReceived: [],
                notifications: [],
                banned: false,
                banReason: '',
                banUntil: null,
                avatar: { headColor: '#ff9999', torsoColor: '#ff9999', legsColor: '#ff9999', accessories: [] },
                jooxBucks: 0,
                canChat,
                theme: 'light'
            };
            setGlobalUsers(users);
            alert('Signed up successfully! Please log in.');
            switchToLogin();
        });

        function isValidUsername(username) {
            const validPattern = /^[A-Za-z0-9_]+$/;
            return username.length > 0 && 
                   username.length <= 20 && 
                   validPattern.test(username) && 
                   !swearWords.some(word => username.toLowerCase().includes(word));
        }

        function calculateAge(birthdate) {
            const today = new Date();
            const birth = new Date(birthdate);
            let age = today.getFullYear() - birth.getFullYear();
            const m = today.getMonth() - birth.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--;
            return age;
        }

        // Friend System Functions
        function searchUsers() {
            const searchTerm = friendSearch.value.trim().toLowerCase();
            const users = getGlobalUsers();
            searchResults.innerHTML = '';

            const currentUserData = users[currentUser];
            const matchingUsers = Object.keys(users).filter(u => 
                u.toLowerCase().includes(searchTerm) && 
                u !== currentUser && 
                !currentUserData.friends.includes(u) && 
                !currentUserData.friendRequestsSent.some(req => req.username === u) &&
                !currentUserData.friendRequestsReceived.some(req => req.username === u)
            );

            if (matchingUsers.length === 0) {
                searchResults.innerHTML = '<p>No users found or already friends/requested.</p>';
                return;
            }

            matchingUsers.forEach(user => {
                const div = document.createElement('div');
                div.innerHTML = `${user} <button onclick="sendFriendRequest('${user}')">Send Friend Request</button>`;
                searchResults.appendChild(div);
            });
        }

        function sendFriendRequest(username) {
            const users = getGlobalUsers();
            const senderData = users[currentUser];
            const receiverData = users[username];

            if (!receiverData) {
                alert('User not found!');
                return;
            }

            if (senderData.friendRequestsSent.some(req => req.username === username)) {
                alert('Friend request already sent!');
                return;
            }

            const requestId = Date.now().toString();
            senderData.friendRequestsSent.push({ id: requestId, username: username });
            receiverData.friendRequestsReceived.push({ id: requestId, username: currentUser });
            receiverData.notifications.push(`Friend request received from @${currentUser}`);
            setGlobalUsers(users);
            alert(`Friend request sent to ${username}!`);
            displayFriends();
        }

        function acceptFriendRequest(requestId) {
            const users = getGlobalUsers();
            const userData = users[currentUser];
            const request = userData.friendRequestsReceived.find(req => req.id === requestId);

            if (!request) {
                alert('Request not found!');
                return;
            }

            const senderUsername = request.username;
            const senderData = users[senderUsername];

            userData.friendRequestsReceived = userData.friendRequestsReceived.filter(req => req.id !== requestId);
            senderData.friendRequestsSent = senderData.friendRequestsSent.filter(req => req.username === currentUser);
            userData.friends.push(senderUsername);
            senderData.friends.push(currentUser);
            senderData.notifications.push(`@${currentUser} accepted your friend request!`);
            setGlobalUsers(users);
            alert(`You are now friends with ${senderUsername}!`);
            displayFriends();
        }

        function declineFriendRequest(requestId) {
            const users = getGlobalUsers();
            const userData = users[currentUser];
            const request = userData.friendRequestsReceived.find(req => req.id === requestId);

            if (!request) {
                alert('Request not found!');
                return;
            }

            const senderUsername = request.username;
            const senderData = users[senderUsername];

            userData.friendRequestsReceived = userData.friendRequestsReceived.filter(req => req.id !== requestId);
            senderData.friendRequestsSent = senderData.friendRequestsSent.filter(req => req.username === currentUser);
            setGlobalUsers(users);
            alert(`Friend request from ${senderUsername} declined.`);
            displayFriends();
        }

        function displayFriends() {
            const users = getGlobalUsers();
            const userData = users[currentUser] || { friends: [], friendRequestsReceived: [] };

            friendsList.innerHTML = '';
            friendRequests.innerHTML = '';

            userData.friends.forEach(friend => {
                const li = document.createElement('li');
                li.textContent = friend;
                friendsList.appendChild(li);
            });

            userData.friendRequestsReceived.forEach(req => {
                const li = document.createElement('li');
                li.innerHTML = `${req.username} <button onclick="acceptFriendRequest('${req.id}')">Accept</button> <button onclick="declineFriendRequest('${req.id}')">Decline</button>`;
                friendRequests.appendChild(li);
            });
        }

        // JooxBucks Functions
        function startJooxBucksTimer() {
            if (!gameInterval) {
                gameInterval = setInterval(() => {
                    const users = getGlobalUsers();
                    users[currentUser].jooxBucks += 2;
                    setGlobalUsers(users);
                    updateJooxBucks();
                }, 60000);
            }
        }

        function updateJooxBucks() {
            const users = getGlobalUsers();
            const userData = users[currentUser];
            document.getElementById('jooxbucks').textContent = `J$${userData.jooxBucks}`;
        }

        // Theme Functions
        function loadTheme() {
            const users = getGlobalUsers();
            const userData = users[currentUser];
            const theme = userData.theme || 'light';
            document.body.className = theme;
            document.getElementById('theme-select').value = theme;
        }

        function toggleTheme() {
            const theme = document.getElementById('theme-select').value;
            const users = getGlobalUsers();
            users[currentUser].theme = theme;
            setGlobalUsers(users);
            document.body.className = theme;
        }

        // Settings Functions
        function changeUsername() {
            const newUsername = document.getElementById('new-username').value.trim();
            const users = getGlobalUsers();

            if (!isValidUsername(newUsername)) {
                alert('Username must be 1-20 characters, use only Latin letters, numbers, or "_", and no inappropriate words.');
                return;
            }
            if (users[newUsername]) {
                alert('This username is already taken.');
                return;
            }

            users[newUsername] = { ...users[currentUser] };
            delete users[currentUser];
            setGlobalUsers(users);
            sessionStorage.setItem('loggedInUser', newUsername);
            currentUser = newUsername;
            alert('Username changed successfully!');
            document.getElementById('new-username').value = '';
            showHomepage();
        }

        // Admin Functions
        function banUser() {
            const username = document.getElementById('admin-username').value.trim();
            const reason = document.getElementById('ban-reason').value.trim();
            const duration = document.getElementById('ban-duration').value;
            const users = getGlobalUsers();

            if (!username) {
                alert('Please enter a username!');
                return;
            }
            if (!users[username]) {
                alert('User not found!');
                return;
            }
            if (username === currentUser) {
                alert('You cannot ban yourself!');
                return;
            }

            users[username].banned = true;
            users[username].banReason = reason;
            users[username].banUntil = duration === 'permanent' ? 'permanent' : Date.now() + duration * 24 * 60 * 60 * 1000;
            users[username].notifications.push(`You have been banned. Reason: ${reason}`);
            setGlobalUsers(users);
            alert(`${username} has been banned.`);
            document.getElementById('admin-username').value = '';
            document.getElementById('ban-reason').value = '';
        }

        function unbanUser() {
            const username = document.getElementById('admin-username').value.trim();
            const reason = document.getElementById('unban-reason').value.trim();
            const users = getGlobalUsers();

            if (!username) {
                alert('Please enter a username!');
                return;
            }
            if (!users[username]) {
                alert('User not found!');
                return;
            }
            if (!users[username].banned) {
                alert('User is not banned!');
                return;
            }

            users[username].banned = false;
            users[username].banReason = '';
            users[username].banUntil = null;
            users[username].notifications.push(`You have been unbanned. Reason: ${reason}`);
            setGlobalUsers(users);
            alert(`${username} has been unbanned.`);
            document.getElementById('admin-username').value = '';
            document.getElementById('unban-reason').value = '';
        }

        function sendAdminNotification() {
            const username = document.getElementById('admin-username').value.trim();
            const text = document.getElementById('notification-text').value.trim();
            const users = getGlobalUsers();

            if (!text) {
                alert('Please enter a notification message!');
                return;
            }

            if (!username) {
                Object.keys(users).forEach(user => {
                    if (user !== 'OfficialJoox') {
                        users[user].notifications.push(`OfficialJoox: ${text}`);
                    }
                });
                setGlobalUsers(users);
                alert('Notification sent to all users.');
            } else {
                if (!users[username]) {
                    alert('User not found!');
                    return;
                }
                users[username].notifications.push(`OfficialJoox: ${text}`);
                setGlobalUsers(users);
                alert(`Notification sent to ${username}.`);
            }

            document.getElementById('admin-username').value = '';
            document.getElementById('notification-text').value = '';
        }

        // Ban Menu Functions
        function showBanMenu(reason, duration) {
            document.getElementById('ban-reason-text').textContent = reason;
            document.getElementById('ban-duration-text').textContent = duration === 'permanent' ? 'Permanent' : `Until ${new Date(duration).toLocaleString()}`;
            hideAllContainers();
            banMenu.style.display = 'block';
        }

        function acknowledgeBan() {
            banMenu.style.display = 'none';
            loginContainer.classList.add('active');
        }

        // JooxBucks Functions
        function startJooxBucksTimer() {
            if (!gameInterval) {
                gameInterval = setInterval(() => {
                    const users = getGlobalUsers();
                    users[currentUser].jooxBucks += 2;
                    setGlobalUsers(users);
                    updateJooxBucks();
                }, 60000);
            }
        }

        function updateJooxBucks() {
            const users = getGlobalUsers();
            const userData = users[currentUser];
            document.getElementById('jooxbucks').textContent = `J$${userData.jooxBucks}`;
        }

        // Avatar Functions
        function loadAvatar() {
            const users = getGlobalUsers();
            const userData = users[currentUser];
            document.getElementById('head-color').value = userData.avatar.headColor;
            document.getElementById('torso-color').value = userData.avatar.torsoColor;
            document.getElementById('legs-color').value = userData.avatar.legsColor;
        }

        function updateAvatarPreview() {
            const ctx = avatarPreviewCanvas.getContext('2d');
            ctx.clearRect(0, 0, avatarPreviewCanvas.width, avatarPreviewCanvas.height);
            const headColor = document.getElementById('head-color').value;
            const torsoColor = document.getElementById('torso-color').value;
            const legsColor = document.getElementById('legs-color').value;
            drawAvatar(ctx, 40, 20, 20, 40, { headColor, torsoColor, legsColor });
        }

        function saveAvatar() {
            const users = getGlobalUsers();
            users[currentUser].avatar.headColor = document.getElementById('head-color').value;
            users[currentUser].avatar.torsoColor = document.getElementById('torso-color').value;
            users[currentUser].avatar.legsColor = document.getElementById('legs-color').value;
            setGlobalUsers(users);
            alert('Avatar saved!');
            updateProfilePic();
            updateProfileDisplay();
        }

        function updateProfilePic() {
            const ctx = profilePicCanvas.getContext('2d');
            ctx.clearRect(0, 0, profilePicCanvas.width, profilePicCanvas.height);
            drawAvatar(ctx, 15, 15, 20, 40);
        }

        function updateProfileDisplay() {
            const users = getGlobalUsers();
            const userData = users[currentUser];
            document.getElementById('profile-username').textContent = `@${currentUser}`;
            const ctx = profileAvatarCanvas.getContext('2d');
            ctx.clearRect(0, 0, profileAvatarCanvas.width, profileAvatarCanvas.height);
            drawAvatar(ctx, 40, 20, 20, 40);
        }

        // Notification Functions
        function displayNotifications() {
            const users = getGlobalUsers();
            const userData = users[currentUser];
            const notiList = document.getElementById('notifications-list');
            notiList.innerHTML = '';
            userData.notifications.forEach(noti => {
                const p = document.createElement('p');
                p.textContent = noti;
                notiList.appendChild(p);
            });
        }

        // Game: Obstacle Parkour
        let obstacleAnimation;
        function startObstacle() {
            const canvas = document.getElementById('obstacle-canvas');
            const ctx = canvas.getContext('2d');
            let level = 1;
            let player = { x: 50, y: 300, width: 20, height: 40, vy: 0, speed: 5, jumping: false };
            let obstacles = generateObstacles(level);
            let keys = {};

            document.addEventListener('keydown', handleKeyDown);
            document.addEventListener('keyup', handleKeyUp);

            function handleKeyDown(e) {
                keys[e.code] = true;
                if (e.code === 'Space' && !player.jumping) {
                    player.vy = -15;
                    player.jumping = true;
                }
            }

            function handleKeyUp(e) {
                keys[e.code] = false;
            }

            function generateObstacles(level) {
                const baseSpeed = 3 + level * 0.5;
                return [
                    { x: 800, y: 350, width: 50, height: 50, speed: baseSpeed },
                    { x: 1000, y: 300, width: 50, height: 100, speed: baseSpeed + 0.5 },
                    { x: 1200, y: 325, width: 75, height: 75, speed: baseSpeed + 1 }
                ];
            }

            function gameLoop() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#87CEEB';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                if (keys['KeyW'] && player.y > 0) player.y -= player.speed;
                if (keys['KeyS'] && player.y < canvas.height - player.height) player.y += player.speed;
                if (keys['KeyA'] && player.x > 0) player.x -= player.speed;
                if (keys['KeyD'] && player.x < canvas.width - player.width) player.x += player.speed;

                player.vy += 0.5;
                player.y += player.vy;
                if (player.y > canvas.height - player.height) {
                    player.y = canvas.height - player.height;
                    player.vy = 0;
                    player.jumping = false;
                }

                drawAvatar(ctx, player.x, player.y - 20, 20, 40);

                obstacles.forEach(ob => {
                    ob.x -= ob.speed;
                    ctx.fillStyle = '#666';
                    ctx.fillRect(ob.x, ob.y, ob.width, ob.height);
                    if (ob.x + ob.width < 0) {
                        ob.x = canvas.width + Math.random() * 200;
                        if (Math.random() < 0.1) level = Math.min(level + 1, 5);
                        obstacles = generateObstacles(level);
                    }
                    if (checkCollision(player, ob)) player.x = 50;
                });

                ctx.fillStyle = '#000';
                ctx.font = '20px Roboto';
                ctx.fillText(`Level: ${level}`, 10, 30);

                obstacleAnimation = requestAnimationFrame(gameLoop);
            }

            function checkCollision(player, obstacle) {
                return player.x < obstacle.x + obstacle.width &&
                       player.x + player.width > obstacle.x &&
                       player.y < obstacle.y + obstacle.height &&
                       player.y + player.height > obstacle.y;
            }

            gameLoop();
        }

        function stopObstacle() {
            cancelAnimationFrame(obstacleAnimation);
            document.removeEventListener('keydown', handleKeyDown);
            document.removeEventListener('keyup', handleKeyUp);
        }

        // Game: Reaction Speed
        let reactionAnimation;
        function startReaction() {
            const canvas = document.getElementById('reaction-canvas');
            const ctx = canvas.getContext('2d');
            let square = { x: 0, y: 0, size: 50, active: false };
            let score = 0;

            function spawnSquare() {
                square.x = Math.random() * (canvas.width - square.size);
                square.y = Math.random() * (canvas.height - square.size);
                square.active = true;
                setTimeout(() => square.active = false, 1000);
            }

            canvas.addEventListener('click', handleClick);

            function handleClick(e) {
                const rect = canvas.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                const clickY = e.clientY - rect.top;
                if (square.active && 
                    clickX >= square.x && clickX <= square.x + square.size && 
                    clickY >= square.y && clickY <= square.y + square.size) {
                    score++;
                    square.active = false;
                    spawnSquare();
                }
            }

            function gameLoop() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#87CEEB';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                drawAvatar(ctx, 50, 180, 20, 40);

                if (square.active) {
                    ctx.fillStyle = '#00FF00';
                    ctx.fillRect(square.x, square.y, square.size, square.size);
                } else if (!square.active && Math.random() < 0.01) {
                    spawnSquare();
                }

                ctx.fillStyle = '#000';
                ctx.font = '20px Roboto';
                ctx.fillText(`Score: ${score}`, 10, 30);

                reactionAnimation = requestAnimationFrame(gameLoop);
            }

            gameLoop();
        }

        function stopReaction() {
            cancelAnimationFrame(reactionAnimation);
            document.getElementById('reaction-canvas').removeEventListener('click', handleClick);
        }

        // Game: Trivia
        let triviaAnimation;
        function startTrivia() {
            const canvas = document.getElementById('trivia-canvas');
            const ctx = canvas.getContext('2d');
            const questions = [
                { q: 'What is 2 + 2?', a: ['4', '3', '5', '6'], correct: '4' },
                { q: 'What color is the sky?', a: ['Blue', 'Green', 'Red', 'Yellow'], correct: 'Blue' },
                { q: 'How many days in a week?', a: ['7', '5', '6', '8'], correct: '7' }
            ];
            let currentQuestion = 0;
            let score = 0;

            function displayQuestion() {
                const question = questions[currentQuestion];
                document.getElementById('trivia-question').textContent = question.q;
                const answersDiv = document.getElementById('trivia-answers');
                answersDiv.innerHTML = '';
                question.a.forEach(answer => {
                    const btn = document.createElement('button');
                    btn.textContent = answer;
                    btn.onclick = () => checkAnswer(answer);
                    answersDiv.appendChild(btn);
                });
            }

            function checkAnswer(answer) {
                if (answer === questions[currentQuestion].correct) score++;
                currentQuestion = (currentQuestion + 1) % questions.length;
                displayQuestion();
            }

            function gameLoop() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#87CEEB';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                drawAvatar(ctx, 50, 180, 20, 40);

                ctx.fillStyle = '#000';
                ctx.font = '20px Roboto';
                ctx.fillText(`Score: ${score}`, 10, 30);

                triviaAnimation = requestAnimationFrame(gameLoop);
            }

            displayQuestion();
            gameLoop();
        }

        function stopTrivia() {
            cancelAnimationFrame(triviaAnimation);
            document.getElementById('trivia-answers').innerHTML = '';
        }

        // Avatar Drawing Function
        function drawAvatar(ctx, x, y, width, height, overrideColors = null) {
            const users = getGlobalUsers();
            const userData = users[currentUser];
            const avatar = userData.avatar;
            const headColor = overrideColors ? overrideColors.headColor : avatar.headColor;
            const torsoColor = overrideColors ? overrideColors.torsoColor : avatar.torsoColor;
            const legsColor = overrideColors ? overrideColors.legsColor : avatar.legsColor;
            const accessories = avatar.accessories;

            // Head
            if (accessories.includes('circle')) {
                ctx.fillStyle = headColor;
                ctx.beginPath();
                ctx.arc(x + width / 2, y + width / 2, width / 2, 0, Math.PI * 2);
                ctx.fill();
            } else {
                ctx.fillStyle = headColor;
                ctx.fillRect(x, y, width, width);
            }

            // Hat
            if (accessories.includes('hat')) {
                ctx.fillStyle = '#8B4513'; // Brown hat
                ctx.fillRect(x - 5, y - 10, width + 10, 10);
            }

            // Glasses
            if (accessories.includes('glasses')) {
                ctx.fillStyle = '#000000';
                ctx.fillRect(x + 2, y + width / 3, 6, 2);
                ctx.fillRect(x + width - 8, y + width / 3, 6, 2);
                ctx.beginPath();
                ctx.moveTo(x + 8, y + width / 3 + 1);
                ctx.lineTo(x + width - 8, y + width / 3 + 1);
                ctx.strokeStyle = '#000000';
                ctx.stroke();
            }

            // Torso
            ctx.fillStyle = torsoColor;
            ctx.fillRect(x - 5, y + width, width + 10, height / 2);
            if (accessories.includes('shirt')) {
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(x, y + width + 5, width, height / 2 - 10);
                ctx.fillStyle = '#000000';
                ctx.font = `${width / 2}px Roboto`;
                ctx.textAlign = 'center';
                ctx.fillText(userData.avatar.shirtText || '', x + width / 2, y + width + height / 4);
            }

            // Legs
            ctx.fillStyle = legsColor;
            if (accessories.includes('pants')) {
                ctx.fillStyle = '#2F4F4F'; // Dark slate gray pants
                ctx.fillRect(x - 5, y + width + height / 2, 10, height / 2);
                ctx.fillRect(x + width - 5, y + width + height / 2, 10, height / 2);
            } else {
                ctx.fillRect(x - 5, y + width + height / 2, 10, height / 2);
                ctx.fillRect(x + width - 5, y + width + height / 2, 10, height / 2);
            }

            // Shoes
            if (accessories.includes('shoes')) {
                ctx.fillStyle = '#000000';
                ctx.fillRect(x - 5, y + width + height - 5, 10, 5);
                ctx.fillRect(x + width - 5, y + width + height - 5, 10, 5);
            }

            // Metro Character
            if (accessories.includes('metro')) {
                ctx.fillStyle = '#000000';
                ctx.fillRect(x - 5, y + width, width + 10, height);
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(x + width / 4, y + width + 10, width / 2, 10);
            }

            // Backpack
            if (accessories.includes('backpack')) {
                ctx.fillStyle = '#228B22'; // Forest green backpack
                ctx.fillRect(x - 10, y + width, width + 20, height / 2);
            }
        }

        // Marketplace Functions
        function purchaseItem(item) {
            const users = getGlobalUsers();
            const userData = users[currentUser];
            let cost = 0;
            switch (item) {
                case 'metro': cost = 120; break;
                case 'circle': cost = 60; break;
                case 'shirt': cost = 25; break;
                case 'hat': cost = 50; break;
                case 'pants': cost = 75; break;
                case 'shoes': cost = 40; break;
                case 'glasses': cost = 30; break;
                case 'backpack': cost = 100; break;
            }
            if (userData.jooxBucks < cost) {
                alert('Not enough J$!');
                return;
            }
            if (userData.avatar.accessories.includes(item)) {
                alert('You already own this item!');
                return;
            }
            userData.jooxBucks -= cost;
            if (item === 'shirt') {
                const shirtText = document.getElementById('shirt-text').value.trim();
                if (!shirtText || !isValidUsername(shirtText)) {
                    alert('Please enter valid shirt text (1-20 characters, Latin letters, numbers, "_", no inappropriate words).');
                    return;
                }
                userData.avatar.shirtText = shirtText;
            }
            userData.avatar.accessories.push(item);
            setGlobalUsers(users);
            alert(`Purchased ${item.charAt(0).toUpperCase() + item.slice(1)}!`);
            updateJooxBucks();
            updateAvatarPreview();
            updateProfilePic();
            updateProfileDisplay();
        }

        // Initialization
        if (sessionStorage.getItem('loggedInUser')) {
            currentUser = sessionStorage.getItem('loggedInUser');
            const users = getGlobalUsers();
            if (users[currentUser] && users[currentUser].banned) {
                const banUntil = users[currentUser].banUntil;
                const banReason = users[currentUser].banReason;
                if (banUntil !== 'permanent' && Date.now() > banUntil) {
                    users[currentUser].banned = false;
                    users[currentUser].banReason = '';
                    users[currentUser].banUntil = null;
                    users[currentUser].notifications.push('Your ban has expired.');
                    setGlobalUsers(users);
                    showHomepage();
                } else {
                    showBanMenu(banReason, banUntil);
                }
            } else {
                showHomepage();
            }
        }

        // Pre-create OfficialJoox admin account if it doesn't exist
        (function initializeOfficialJoox() {
            const users = getGlobalUsers();
            if (!users['OfficialJoox']) {
                users['OfficialJoox'] = {
                    password: 'admin123', // Change this to a secure password
                    birthdate: '2000-01-01',
                    friends: [],
                    friendRequestsSent: [],
                    friendRequestsReceived: [],
                    notifications: [],
                    banned: false,
                    banReason: '',
                    banUntil: null,
                    avatar: { headColor: '#ff9999', torsoColor: '#ff9999', legsColor: '#ff9999', accessories: [] },
                    jooxBucks: 1000,
                    canChat: true,
                    theme: 'light'
                };
                setGlobalUsers(users);
            }
        })();
    </script>
</body>
</html>